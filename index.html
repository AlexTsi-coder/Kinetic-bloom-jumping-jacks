<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>AI Jumping Jacks Coach</title>
  <style>
    body {
      margin: 0;
      background: #000;
      overflow: hidden;
      font-family: sans-serif;
    }
    #container {
      position: relative;
      width: 100%;
      height: 100vh;
    }
    #webcam, #output {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #counter {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 3em;
      color: #fff;
      text-shadow: 2px 2px 6px #000;
      z-index: 30;
    }
    .feedback {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      font-size: 1.4em;
      font-weight: bold;
      padding: 10px 18px;
      border-radius: 6px;
      text-shadow: 1px 1px 3px #000;
      max-width: 90%;
      white-space: nowrap;
      z-index: 35;
    }
    /* Πρώτη γραμμή: οδηγίες δράσης */
    #action {
      bottom: 120px;
      background: rgba(0, 102, 204, 0.85);
    }
    /* Δεύτερη γραμμή: τεχνική */
    #technique {
      bottom: 70px;
      background: rgba(0, 0, 0, 0.65);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
</head>
<body>
<div id="container">
  <video id="webcam" playsinline muted></video>
  <canvas id="output"></canvas>
  <div id="counter">0</div>
  <div id="action" class="feedback"></div>
  <div id="technique" class="feedback"></div>
</div>
<script>
const video=document.getElementById('webcam'),
      canvas=document.getElementById('output'),
      ctx=canvas.getContext('2d'),
      counter=document.getElementById('counter'),
      action=document.getElementById('action'),
      tech=document.getElementById('technique');

let detector,state="closed",count=0;

async function setupCam(){
  const s=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=s;
  return new Promise(r=>{video.onloadedmetadata=()=>{video.play();r(video);};});
}

async function loadModel(){
  detector=await poseDetection.createDetector(
    poseDetection.SupportedModels.MoveNet,
    {modelType:poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING}
  );
  detect();
}

function checkTechnique(kp){
  if(kp.length<17) return "Φανερώσου ολόκληρος στο κάδρο!";
  const lAnkle=kp[15],rAnkle=kp[16],
        lWrist=kp[9],rWrist=kp[10];
  if([lAnkle,rAnkle,lWrist,rWrist].some(p=>!p||p.score<0.4))
    return "Φανερώσου ολόκληρος στο κάδρο!";
  // Έλεγχος συμμετρίας
  if(Math.abs(lAnkle.y-rAnkle.y)>50) return "Ισορρόπησε τα πόδια!";
  if(Math.abs(lWrist.y-rWrist.y)>80) return "Κράτα τα χέρια συμμετρικά!";
  return "Τέλεια τεχνική!";
}

async function detect(){
  const poses=await detector.estimatePoses(video);
  if(poses.length>0){
    const kp=poses[0].keypoints,
          lAnkle=kp[15],rAnkle=kp[16],
          lWrist=kp[9],rWrist=kp[10];
    if(lAnkle&&rAnkle&&lWrist&&rWrist&&
       lAnkle.score>0.4&&rAnkle.score>0.4&&
       lWrist.score>0.4&&rWrist.score>0.4){

      const ankleDist=Math.abs(lAnkle.x-rAnkle.x);
      const wristHeight=(lWrist.y+rWrist.y)/2;
      const head=kp[0];

      // Κριτήριο "open" όταν πόδια ανοιχτά και χέρια ψηλά
      if(ankleDist>250 && wristHeight<head.y && state==="closed"){
        state="open";
        action.textContent="Άνοιξε!";
      }
      // Κριτήριο "closed" όταν πόδια κοντά και χέρια χαμηλά
      else if(ankleDist<150 && wristHeight>head.y+100 && state==="open"){
        state="closed";
        count++;
        counter.textContent=count;
        action.textContent="Κλείσε!";
      }
    }
    const tMsg=checkTechnique(kp);
    tech.textContent=tMsg;
    tech.style.background=tMsg==="Τέλεια τεχνική!"?"rgba(0,153,51,0.8)":"rgba(204,0,0,0.8)";

    ctx.clearRect(0,0,canvas.width,canvas.height);
    canvas.width=video.videoWidth;canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    for(let p of kp){if(p.score>0.4){ctx.fillStyle="yellow";ctx.beginPath();ctx.arc(p.x,p.y,5,0,2*Math.PI);ctx.fill();}}
  }
  requestAnimationFrame(detect);
}

setupCam();loadModel();
</script>
</body>
</html>
