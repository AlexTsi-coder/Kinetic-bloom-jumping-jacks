<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>AI Jumping Jacks Coach</title>
  <style>
    body {margin:0;background:#000;font-family:sans-serif;overflow:hidden}
    #container {position:relative;width:100%;height:100vh}
    #webcam,#output {position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    #counter {
      position:absolute;top:20px;left:50%;transform:translateX(-50%);
      font-size:3em;color:#fff;text-shadow:2px 2px 6px #000;z-index:20
    }
    .feedback-line {
      position:absolute;left:50%;transform:translateX(-50%);
      color:#fff;padding:8px 14px;border-radius:8px;
      font-size:1.3em;font-weight:bold;z-index:25;white-space:nowrap;
      text-shadow:1px 1px 4px #000;backdrop-filter:blur(4px)
    }
    #feedback-action {bottom:120px;background:rgba(0,102,204,0.9)}
    #feedback-technique {bottom:70px;background:rgba(0,153,51,0.9)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
</head>
<body>
<div id="container">
  <video id="webcam" playsinline muted></video>
  <canvas id="output"></canvas>
  <div id="counter">0</div>
  <div id="feedback-action" class="feedback-line"></div>
  <div id="feedback-technique" class="feedback-line"></div>
</div>
<script>
const video=document.getElementById('webcam'),
      canvas=document.getElementById('output'),
      ctx=canvas.getContext('2d'),
      counterDiv=document.getElementById('counter'),
      feedbackAction=document.getElementById('feedback-action'),
      feedbackTechnique=document.getElementById('feedback-technique');

let detector,jackCount=0,inOpen=false;

async function setupWebcam(){
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
  video.srcObject=stream;
  return new Promise(res=>video.onloadedmetadata=()=>{video.play();res();});
}

async function loadModel(){
  detector=await poseDetection.createDetector(
    poseDetection.SupportedModels.MoveNet,
    {modelType:'SinglePose.Lightning'}
  );
}

function distance(p1,p2){return Math.hypot(p1.x-p2.x,p1.y-p2.y);}

function checkForm(kp){
  const shoulderW=distance(kp[5],kp[6]);
  const legGap=distance(kp[11],kp[12]);
  if(legGap<shoulderW*0.5) return "Κλείσε καλά τα πόδια";
  if(legGap>shoulderW*2.2) return "Μην ανοίγεις υπερβολικά";
  return "Καλή στάση!";
}

async function loop(){
  const poses=await detector.estimatePoses(video,{flipHorizontal:true});
  if(poses.length){
    const kp=poses[0].keypoints;
    if(kp[5]&&kp[6]&&kp[11]&&kp[12]){
      const shoulderW=distance(kp[5],kp[6]);
      const legGap=distance(kp[11],kp[12]);

      feedbackTechnique.textContent=checkForm(kp);

      if(!inOpen && legGap>shoulderW*1.8){
        inOpen=true; feedbackAction.textContent="Ανοίγεις";
      }
      if(inOpen && legGap<shoulderW*0.8){
        jackCount++; inOpen=false;
        feedbackAction.textContent="Κλείνεις";
      }
      counterDiv.textContent=jackCount;
    }
    drawPose(kp);
  }
  requestAnimationFrame(loop);
}

function drawPose(keypoints){
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  keypoints.forEach(k=>{
    if(k.score>0.4){
      ctx.beginPath();
      ctx.arc(k.x,k.y,5,0,2*Math.PI);
      ctx.fillStyle="yellow";
      ctx.fill();
    }
  });
}

(async()=>{
  await setupWebcam();
  await loadModel();
  loop();
})();
</script>
</body>
</html>
